@model int
@{
    ViewBag.Title = "Deatils";
    Layout = "~/Areas/App/Views/Shared/_Layout.cshtml";
}

@section vendorStyle{

    <link href="../../assets/vendor/libs/node-waves/node-waves.css" rel="stylesheet" />
    <link href="../../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" rel="stylesheet" />
    <link href="../../assets/vendor/libs/typeahead-js/typeahead.css" rel="stylesheet" />
    <link href="../../assets/vendor/libs/datatables-bs5/datatables.bootstrap5.css" rel="stylesheet" />
    <link href="../../assets/vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css" rel="stylesheet" />
    <link href="../../assets/vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css" rel="stylesheet" />
    <link href="../../assets/vendor/libs/animate-css/animate.css" rel="stylesheet" />
    <link href="../../assets/vendor/libs/sweetalert2/sweetalert2.css" rel="stylesheet" />
    <link href="../../assets/vendor/libs/select2/select2.css" rel="stylesheet" />
    <link rel="stylesheet" href="@Url.Content("~/assets/vendor/libs/@form-validation/form-validation.css")" />
    <link href="../../assets/vendor/css/pages/page-user-view.css" rel="stylesheet" />
}
@{
    var Role = V2boardApi.Tools.JwtToken.GetUserRole();
}
<h4 class="py-3 mb-4">
    <span class="text-muted fw-light">مشاهده کاربر/</span>
    حساب کاربری
</h4>
<div class="row">
    <!-- User Sidebar -->
    <div class="col-xl-4 col-lg-5 col-md-5 order-1 order-md-0">
        <!-- User Card -->
        @Html.Action("_UserCard", "Admin", new { area = "App", userid = Model })
        <!-- /User Card -->
        <!-- /Plan Card -->
    </div>
    <!--/ User Sidebar -->
    <!-- User Content -->
    <div class="col-xl-8 col-lg-7 col-md-7 order-0 order-md-1">
        <!-- User Pills -->
        <ul class="nav nav-pills flex-column flex-md-row mb-4">
            <li class="nav-item">
                @if (ViewBag.Type == "history")
                {
                    <a class="nav-link active" href="@Url.Action("Details","Admin",new {area="App",type="history",user_id=Model})">
                        <i class="ti ti-users ti-xs me-1"></i>
                        تاریخچه
                    </a>
                }
                else
                {
                    <a class="nav-link" href="@Url.Action("Details","Admin",new {area="App",type="history",user_id=Model})">
                        <i class="ti ti-users ti-xs me-1"></i>
                        تاریخچه
                    </a>
                }
            </li>
            <li class="nav-item">
                @if (ViewBag.Type == "Factors")
                {
                    <a class="nav-link active" href="@Url.Action("Details","Admin",new {area="App",type="Factors",user_id=Model})">
                        <i class="ti ti-cash ti-xs me-1"></i>
                        فاکتور ها
                    </a>
                }
                else
                {
                    <a class="nav-link" href="@Url.Action("Details","Admin",new {area="App",type="Factors",user_id=Model})">
                        <i class="ti ti-cash ti-xs me-1"></i>
                        فاکتور ها
                    </a>
                }
            </li>
            @if (Role == "1")
            {
                <li class="nav-item">
                    @if (ViewBag.Type == "Settings")
                    {
                        <a class="nav-link active" href="@Url.Action("Details","Admin",new {area="App",type="Settings",user_id=Model})">
                            <i class="ti ti-settings ti-xs me-1"></i>
                            تنظیمات
                        </a>
                    }
                    else
                    {
                        <a class="nav-link" href="@Url.Action("Details","Admin",new {area="App",type="Settings",user_id=Model})">
                            <i class="ti ti-settings ti-xs me-1"></i>
                            تنظیمات
                        </a>
                    }
                </li>
            }
        </ul>
        @if (ViewBag.Type == "history")
        {
            <div class="card mb-4">
                <div class="table-responsive mb-3">
                    <table class="table datatable-sub border-top">
                        <thead>
                            <tr>
                                <th></th>
                                <th>نام اشتراک</th>
                                <th>رویداد</th>
                                <th>تاریخ ایجاد</th>
                                <th>مبلغ فروش</th>
                                <th>تعرفه</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        }
        else if (ViewBag.Type == "Factors")
        {
            <div class="card mb-4">
                <div class="table-responsive mb-3">
                    <table class="table datatable-invoice border-top">
                        <thead>
                            <tr>
                                <th></th>
                                <th>تاریخ پرداخت</th>
                                <th>مبلغ پرداختی</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        }
        else if (ViewBag.Type == "Settings")
        {
            <div class="card mb-3">
                <div class="card-header pt-2">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item">
                            <button aria-selected="false" class="nav-link active" data-bs-target="#form-tabs-account" data-bs-toggle="tab" role="tab" onclick="AgentTab()">نمایندگی</button>
                        </li>
                        <li class="nav-item">
                            <button aria-selected="false" class="nav-link" data-bs-target="#form-tabs-social" data-bs-toggle="tab" role="tab" id="botSettingTab">ربات</button>
                        </li>
                        <li class="nav-item">
                            <button aria-selected="false" class="nav-link" data-bs-target="#form-tabs-cards" data-bs-toggle="tab" role="tab">کارت ها</button>
                        </li>
                    </ul>
                </div>
                <div class="tab-content section-block">
                    <div class="tab-pane active show" id="form-tabs-account" role="tabpanel">
                        <form class="row g-3" id="editPriceForm">
                            <input type="hidden" name="user_id" id="user_id" value="@Model" />
                            <input type="hidden" name="id" id="id" value="" />
                            <div class="row">
                                <div class="col-12 col-md-3" data-bs-toggle="popover" title="تعیین کننده نود های قابل دسترسی">
                                    <label class="form-label" for="planGroup">دسته بندی<span class="text-danger"> * </span></label>
                                    <select id="planGroup" class="select2 form-select" autocomplete="off" name="planGroup">
                                        <option value="-1">در حال بارگزاری ...</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-3">
                                    <label class="form-label" for="userPriceForGig"> قیمت هرگیگ <span class="text-danger"> * </span></label>
                                    <input class="form-control" id="userPriceForGig" name="userPriceForGig" placeholder="" type="number" min="0" max="1000000000" />
                                </div>
                                <div class="col-12 col-md-3">
                                    <label class="form-label" for="userPriceForMonth"> قیمت هرماه <span class="text-danger"> * </span></label>
                                    <input class="form-control" id="userPriceForMonth" name="userPriceForMonth" placeholder="" type="number" min="0" max="1000000000" />
                                </div>
                                <div class="col-12 col-md-3">
                                    <label class="form-label" for="userPriceForUser"> قیمت کاربر <span class="text-danger"> * </span></label>
                                    <input class="form-control" id="userPriceForUser" name="userPriceForUser" placeholder="" type="number" min="0" max="1000000000" />
                                </div>
                            </div>
                            <div class="col-12" style="text-align:left;">
                                <button class="btn btn-primary me-sm-3 me-1" type="submit">ثبت</button>

                            </div>
                        </form>
                        <br />
                        <div class="card-datatable table-responsive">
                            <table class="datatables-groups table">
                                <thead class="border-top">
                                    <tr>
                                        <th></th>
                                        <th>دسته بندی</th>
                                        <th>قیمت هر گیگ</th>
                                        <th>قیمت هر ماه</th>
                                        <th>قیمت هر کاربر</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="form-tabs-social" role="tabpanel">
                        @Html.Action("_GetBotSetting", "Admin", new { area = "App", user_id = Model })
                    </div>
                    <div class="tab-pane fade" id="form-tabs-cards" role="tabpanel">
                        @Html.Action("_GetBankNumbers", "Admin", new { area = "App", user_id = Model })
                    </div>

                </div>
            </div>

        }
    </div>
</div>
<!-- Modal -->
<!-- Edit Setting Modal -->
@*@if (Role == "1")
    {

        @Html.Action("_GetSetting", "Admin", new { area = "App", user_id = Model })
    }*@
<!--/ Edit Setting Modal -->
<!-- Edit Wallet Modal -->
@Html.Action("_EditWallet", "Admin", new { area = "App", user_id = Model })

<!--/ Edit Wallet Modal -->


@section vendorScripts {

    <script src="../../assets/vendor/libs/moment/moment.js"></script>
    <script src="../../assets/vendor/libs/datatables-bs5/datatables-bootstrap5.js"></script>
    <script src="../../assets/vendor/libs/datatables-bs5/i18n/fa.js"></script>
    <script src="../../assets/vendor/libs/sweetalert2/sweetalert2.js"></script>
    <script src="../../assets/vendor/libs/typeahead-js/typeahead.js"></script>
    <script src="../../assets/vendor/libs/cleavejs/cleave.js"></script>
    <script src="../../assets/vendor/libs/cleavejs/cleave-phone.js"></script>
    <script src="../../assets/vendor/libs/select2/select2.js"></script>
    <script src="../../assets/vendor/libs/select2/i18n/fa.js"></script>
    <script src="@Url.Content("~/assets/vendor/libs/@form-validation/popular.js")"></script>
    <script src="@Url.Content("~/assets/vendor/libs/@form-validation/bootstrap5.js")"></script>
    <script src="@Url.Content("~/assets/vendor/libs/@form-validation/auto-focus.js")"></script>
    <script src="../../assets/vendor/libs/block-ui/block-ui.js"></script>
}


@section customScripts {

    <script src="../../assets/js/modal-edit-wallet.js"></script>
    <script src="../../assets/js/app-user-view.js"></script>
    <script src="../../assets/js/app-user-view-account.js"></script>



    <script>

                $(function () {

                    $("#planGroup").wrap('<div class="position-relative"></div>').select2({
                        placeholder: 'انتخاب دسته بندی',
                        dropdownParent: $("#planGroup").parent(),
                        allowClear: false
                    });

                    Groups("#planGroup");
                    $('[data-bs-toggle="popover"]').tooltip();

                    debugger


                });

        $("#botSettingTab").on('click', function () {
            var plan_id = $("#plan_id").val();

            $("#userPlan").val(plan_id).trigger('change');
        });


                function SelectGroup(selectId, Ids) {
                    $(selectId).val(Ids).trigger('change');
                }

                function Groups(selectId) {
                    var $select = $(selectId);
                    $.ajax({
                        url: "/App/ServerGroups/_SelectGroups",
                        type: "get",
                        dataType: "json",
                        async: true,
                        success: function (res) {
                            console.log(res);
                            // پاک کردن گزینه‌های قبلی
                            $select.empty();

                            // افزودن گزینه‌های جدید
                            $.each(res.data, function (index, item) {
                                var newOption = new Option(item.GroupName, item.ID, false, false);
                                $select.append(newOption);
                            });
                        },
                        error: function (xhr, status, error) {
                            console.error("An error occurred: " + status + " " + error);
                        }
                    });

                }





                $("#ZeroWallet").click(function () {

                    $("#Deposit").val(0);

                });

                $("#SaveDeposit").click(function () {

                    $("#editWalletForm").find("#user_id").val(getUrlParameter("user_id"));

                    AjaxFormPost("/App/Admin/EditWallet", "#editWalletForm").then(res => {


                        eval(res.data);
                        if (res.status == "success") {
                            $("#editWallet").modal("hide");
                        }

                    });

                });


                function ChangeAgent(inp) {
                    var Check = $(inp).is(':checked');
                    var user_id = '@Model';
                    BodyBlockUI();
                    $.ajax({
                        url: "@Url.Action("ChangeAgent","Admin")",
                        type: "Post",
                        dataType: "json",
                        data: { status: Check, user_id: user_id },
                        success: function (res) {
                            BodyUnblockUI();
                            if (res.status != "success") {
                                eval(res.data);
                                $(inp).prop("checked", false);
                            }

                        }
                    });


                }


                // ثبت تنظیمات نمایندگی
                function AgentTab() {

                    const editPriceForm = document.getElementById('editPriceForm');

                    // Form validation for Add new record
                    const fv = FormValidation.formValidation(editPriceForm, {
                        fields: {
                            userPrice: {
                                validators: {
                                    between: {
                                        min: 0,
                                        max: 1000000000,
                                        message: 'قیمت هر گیگ حداکثر می تواند 1000,000,000 تومان باشد'
                                    }
                                }
                            },
                            userMonth: {
                                validators: {
                                    between: {
                                        min: 0,
                                        max: 1000000000,
                                        message: 'قیمت هر ماه حداکثر می تواند 1000,000,000 تومان باشد'
                                    }
                                }
                            }
                        },
                        plugins: {
                            trigger: new FormValidation.plugins.Trigger(),
                            bootstrap5: new FormValidation.plugins.Bootstrap5({
                                // Use this for enabling/changing valid/invalid class
                                // eleInvalidClass: '',
                                eleValidClass: '',
                                rowSelector: '.col-md-6'
                            }),
                            submitButton: new FormValidation.plugins.SubmitButton(),
                            // defaultSubmit: new FormValidation.plugins.DefaultSubmit(),
                            autoFocus: new FormValidation.plugins.AutoFocus(),


                        },
                        init: instance => {
                            instance.on('plugins.message.placed', function (e) {
                                if (e.element.parentElement.classList.contains('input-group')) {
                                    e.element.parentElement.insertAdjacentElement('afterend', e.messageElement);
                                }
                            });
                        }
                    });

                    fv.on('core.form.valid', function (e) {
                        console.log("form is valid");
                        BodyBlockUI();
                        AjaxFormPost('/App/Admin/SetPriceSetting', "#editPriceForm").then(res => {
                            BodyUnblockUI();
                            eval(res.data);

                        });
                    });
                }


                //ثبت تنظیمات کلی

                $("#SaveGroup").click(function () {

                    $("#groupForm").find("#user_id").val(getUrlParameter("user_id"));

                    AjaxFormPost("/App/Admin/SetGeneralSetting", "#groupForm").then(res => {

                        eval(res.data);

                    });
                });
    </script>

}
